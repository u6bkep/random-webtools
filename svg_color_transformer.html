        <div class="section">
            <h2>Color Management</h2>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background: #667eea;"></div>
                    <span>Auto-detected for transformation</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #48bb78;"></div>
                    <span>Forced to transform</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #f56565;"></div>
                    <span>Excluded from transformation</span>
                </div>
                <div class="legend-item">
                    <span style="color: #718096;">Click any color to toggle its transformation state</span>
                </div>
            </div>
            <div class="color-grid" id="colorGrid"></div>
        </div><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Color Transformer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .section h2 {
            margin-top: 0;
            color: #4a5568;
            font-size: 1.3em;
        }
        
        .input-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid transparent;
        }
        
        .tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .file-upload {
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
        }
        
        .file-upload:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .file-upload.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }
        
        .file-upload input[type="file"] {
            display: none;
        }
        
        .upload-text {
            font-size: 16px;
            color: #4a5568;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 14px;
            color: #718096;
        }
        
        textarea {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }
        
        select, input[type="range"] {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            padding: 0;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .color-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .color-item:hover {
            border-color: #cbd5e0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .color-item.excluded {
            border-color: #f56565;
            background: rgba(245, 101, 101, 0.1);
        }
        
        .color-item.forced {
            border-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }
        
        .color-item.auto-detected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .color-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .color-swatch-large {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        
        .color-info {
            flex: 1;
        }
        
        .color-hex {
            font-family: monospace;
            font-weight: 600;
            font-size: 13px;
            color: #4a5568;
        }
        
        .color-status {
            font-size: 11px;
            color: #718096;
            margin-top: 2px;
        }
        
        .color-count {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .status-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .status-badge.excluded {
            background: #f56565;
        }
        
        .status-badge.forced {
            background: #48bb78;
        }
        
        .status-badge.auto {
            background: #667eea;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 12px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .threshold-value {
            background: #f7fafc;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-weight: 600;
            color: #667eea;
        }
        
        .preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .preview-panel {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .preview-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #4a5568;
            font-size: 1.1em;
            text-align: center;
        }
        
        .svg-preview {
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(248, 250, 252, 0.8);
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        
        .svg-preview svg {
            max-width: 100%;
            max-height: 100%;
            height: auto;
            width: auto;
        }
        
        .preview-placeholder {
            color: #a0aec0;
            font-style: italic;
            text-align: center;
        }
        
        .download-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 11px;
            color: #718096;
            margin-top: 5px;
        }
        
        .color-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
        }
        
        .filename {
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .preview-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SVG Color Transformer</h1>
        
        <div class="section">
            <h2>Input</h2>
            <div class="input-tabs">
                <div class="tab active" onclick="switchTab('upload')">Upload SVG File</div>
                <div class="tab" onclick="switchTab('text')">Paste SVG Code</div>
            </div>
            
            <div id="upload-content" class="tab-content active">
                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".svg,image/svg+xml" onchange="handleFileUpload(event)">
                    <div class="upload-text">üìÅ Click to upload SVG file</div>
                    <div class="upload-hint">or drag and drop an SVG file here</div>
                </div>
            </div>
            
            <div id="text-content" class="tab-content">
                <textarea id="textInput" placeholder='Paste your SVG code here, e.g.:
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
  <circle cx="50" cy="50" r="40" fill="#ff0000" stroke="#0000ff"/>
</svg>'>
                </textarea>
            </div>
        </div>
        
        <div class="section">
            <h2>Transformation Settings</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="fromColor">Transform From:</label>
                    <select id="fromColor" onchange="transformSVG()">
                        <option value="red">Red</option>
                        <option value="green">Green</option>
                        <option value="blue">Blue</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="toColor">Transform To:</label>
                    <select id="toColor" onchange="transformSVG()">
                        <option value="red">Red</option>
                        <option value="green" selected>Green</option>
                        <option value="blue">Blue</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="threshold">Primary Color Threshold:</label>
                    <input type="range" id="threshold" min="0" max="1" step="0.01" value="0.5" oninput="updateThreshold(); transformSVG()">
                    <div class="threshold-value" id="thresholdValue">0.50</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>Live Preview</h2>
            <div id="currentFilename" class="filename" style="display: none;"></div>
            <div class="stats" id="stats"></div>
            <div class="color-preview" id="colorPreview"></div>
            
            <div class="preview-container">
                <div class="preview-panel">
                    <h3>Original</h3>
                    <div class="svg-preview" id="originalPreview">
                        <div class="preview-placeholder">Upload an SVG file or paste SVG code to see preview</div>
                    </div>
                </div>
                
                <div class="preview-panel">
                    <h3>Transformed</h3>
                    <div class="svg-preview" id="transformedPreview">
                        <div class="preview-placeholder">Transformed SVG will appear here</div>
                    </div>
                    <div class="download-buttons">
                        <button id="downloadBtn" onclick="downloadSVG()" disabled>Download Transformed SVG</button>
                        <button onclick="copySVGCode()" disabled id="copyBtn">Copy SVG Code</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let originalSVG = '';
        let transformedSVG = '';
        let currentFilename = 'transformed.svg';
        let colorStates = {}; // Track manual overrides: 'auto', 'forced', 'excluded'
        let allColors = []; // Store all unique colors found

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-content`).classList.add('active');
            
            if (tab === 'text') {
                const textInput = document.getElementById('textInput');
                if (textInput.value.trim()) {
                    processSVG(textInput.value, 'pasted-svg.svg');
                }
            }
        }

        // File upload handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type === 'image/svg+xml') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processSVG(e.target.result, file.name);
                };
                reader.readAsText(file);
            }
        }

        // Drag and drop
        const fileUpload = document.querySelector('.file-upload');
        fileUpload.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        fileUpload.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });

        fileUpload.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'image/svg+xml') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processSVG(e.target.result, file.name);
                };
                reader.readAsText(file);
            }
        });

        // Text input handling
        document.getElementById('textInput').addEventListener('input', function() {
            if (this.value.trim()) {
                processSVG(this.value, 'pasted-svg.svg');
            }
        });

        function processSVG(svgContent, filename) {
            originalSVG = svgContent;
            currentFilename = filename.replace('.svg', '-transformed.svg');
            
            // Reset color states for new SVG
            colorStates = {};
            
            // Show filename
            const filenameEl = document.getElementById('currentFilename');
            filenameEl.textContent = `File: ${filename}`;
            filenameEl.style.display = 'block';
            
            // Extract all colors and build color grid
            extractAndDisplayColors();
            
            // Display original SVG
            displaySVG('originalPreview', originalSVG);
            
            // Transform and display
            transformSVG();
        }

        function displaySVG(containerId, svgContent) {
            const container = document.getElementById(containerId);
            if (svgContent && svgContent.trim()) {
                // Clean the SVG content and ensure it has proper namespace
                let cleanSVG = svgContent.trim();
                if (!cleanSVG.includes('xmlns')) {
                    cleanSVG = cleanSVG.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                container.innerHTML = cleanSVG;
            } else {
                container.innerHTML = '<div class="preview-placeholder">No SVG content</div>';
            }
        }

        function updateThreshold() {
            const threshold = document.getElementById('threshold').value;
            document.getElementById('thresholdValue').textContent = parseFloat(threshold).toFixed(2);
        }

        function extractAndDisplayColors() {
            const colorRegex = /#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})/g;
            const matches = originalSVG.match(colorRegex) || [];
            
            // Normalize and count colors
            const colorCounts = {};
            matches.forEach(color => {
                let normalizedColor = color.toLowerCase();
                if (normalizedColor.length === 4) {
                    normalizedColor = `#${normalizedColor[1]}${normalizedColor[1]}${normalizedColor[2]}${normalizedColor[2]}${normalizedColor[3]}${normalizedColor[3]}`;
                }
                colorCounts[normalizedColor] = (colorCounts[normalizedColor] || 0) + 1;
            });
            
            allColors = Object.keys(colorCounts).sort();
            
            // Build color grid
            displayColorGrid(colorCounts);
        }

        function displayColorGrid(colorCounts) {
            const fromColor = document.getElementById('fromColor').value;
            const threshold = parseFloat(document.getElementById('threshold').value);
            
            const gridHtml = allColors.map(color => {
                const count = colorCounts[color];
                const state = colorStates[color] || 'auto';
                
                let isAutoDetected = false;
                if (state === 'auto') {
                    isAutoDetected = isPrimaryColor(color, fromColor, threshold);
                }
                
                const shouldTransform = state === 'forced' || (state === 'auto' && isAutoDetected);
                
                let statusClass = '';
                let statusText = '';
                let badgeClass = '';
                
                if (state === 'excluded') {
                    statusClass = 'excluded';
                    statusText = 'Excluded from transformation';
                    badgeClass = 'excluded';
                } else if (state === 'forced') {
                    statusClass = 'forced';
                    statusText = 'Forced to transform';
                    badgeClass = 'forced';
                } else if (isAutoDetected) {
                    statusClass = 'auto-detected';
                    statusText = 'Auto-detected for transformation';
                    badgeClass = 'auto';
                } else {
                    statusText = 'Not selected for transformation';
                }
                
                return `
                    <div class="color-item ${statusClass}" onclick="toggleColorState('${color}')">
                        <div class="status-badge ${badgeClass}"></div>
                        <div class="color-display">
                            <div class="color-swatch-large" style="background-color: ${color}"></div>
                            <div class="color-info">
                                <div class="color-hex">${color.toUpperCase()}</div>
                                <div class="color-count">${count} use${count !== 1 ? 's' : ''}</div>
                            </div>
                        </div>
                        <div class="color-status">${statusText}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('colorGrid').innerHTML = gridHtml;
        }

        function toggleColorState(color) {
            const currentState = colorStates[color] || 'auto';
            
            // Cycle through states: auto -> excluded -> forced -> auto
            switch (currentState) {
                case 'auto':
                    colorStates[color] = 'excluded';
                    break;
                case 'excluded':
                    colorStates[color] = 'forced';
                    break;
                case 'forced':
                    colorStates[color] = 'auto';
                    break;
            }
            
            // Refresh display and transform
            displayColorGrid(allColors.reduce((acc, c) => {
                // Count occurrences for display
                const matches = originalSVG.match(new RegExp(c.replace('#', '\\#'), 'gi')) || [];
                acc[c] = matches.length;
                return acc;
            }, {}));
            
            transformSVG();
        }

        // Color transformation functions (same as before)
        function hexToHsv(hex) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const diff = max - min;
            
            let h = 0;
            if (diff !== 0) {
                if (max === r) h = ((g - b) / diff) % 6;
                else if (max === g) h = (b - r) / diff + 2;
                else h = (r - g) / diff + 4;
            }
            h = Math.round(h * 60);
            if (h < 0) h += 360;
            
            const s = max === 0 ? 0 : diff / max;
            const v = max;
            
            return [h, s, v];
        }

        function hsvToHex(h, s, v) {
            const c = v * s;
            const x = c * (1 - Math.abs((h / 60) % 2 - 1));
            const m = v - c;
            
            let r, g, b;
            if (h >= 0 && h < 60) [r, g, b] = [c, x, 0];
            else if (h >= 60 && h < 120) [r, g, b] = [x, c, 0];
            else if (h >= 120 && h < 180) [r, g, b] = [0, c, x];
            else if (h >= 180 && h < 240) [r, g, b] = [0, x, c];
            else if (h >= 240 && h < 300) [r, g, b] = [x, 0, c];
            else [r, g, b] = [c, 0, x];
            
            r = Math.round((r + m) * 255);
            g = Math.round((g + m) * 255);
            b = Math.round((b + m) * 255);
            
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        function isPrimaryColor(hex, targetColor, threshold) {
            const [h, s, v] = hexToHsv(hex);
            
            if (s < 0.3 || v < 0.3) return false;
            
            let targetHueRanges = [];
            switch (targetColor) {
                case 'red':
                    targetHueRanges = [[0, 30], [330, 360]];
                    break;
                case 'green':
                    targetHueRanges = [[90, 150]];
                    break;
                case 'blue':
                    targetHueRanges = [[210, 270]];
                    break;
            }
            
            const inRange = targetHueRanges.some(([min, max]) => h >= min && h <= max);
            if (!inRange) return false;
            
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            
            const max = Math.max(r, g, b);
            const dominantRatio = max / Math.max(0.01, Math.max(...[r, g, b].filter(x => x !== max)));
            
            if (dominantRatio < (1 + threshold)) return false;
            
            switch (targetColor) {
                case 'red': return r === max;
                case 'green': return g === max;
                case 'blue': return b === max;
            }
            return false;
        }

        function transformColor(hex, fromColor, toColor) {
            const [h, s, v] = hexToHsv(hex);
            
            let newHue = h;
            const hueShifts = {
                'red': { 'green': 120, 'blue': 240 },
                'green': { 'red': -120, 'blue': 120 },
                'blue': { 'red': -240, 'green': -120 }
            };
            
            if (fromColor !== toColor && hueShifts[fromColor] && hueShifts[fromColor][toColor]) {
                newHue = (h + hueShifts[fromColor][toColor] + 360) % 360;
            }
            
            return hsvToHex(newHue, s, v);
        }

        function transformSVG() {
            if (!originalSVG || allColors.length === 0) return;
            
            const fromColor = document.getElementById('fromColor').value;
            const toColor = document.getElementById('toColor').value;
            const threshold = parseFloat(document.getElementById('threshold').value);
            
            transformedSVG = originalSVG;
            let transformedCount = 0;
            const transformedColors = new Set();
            
            allColors.forEach(color => {
                const state = colorStates[color] || 'auto';
                let shouldTransform = false;
                
                if (state === 'forced') {
                    shouldTransform = true;
                } else if (state === 'excluded') {
                    shouldTransform = false;
                } else { // auto
                    shouldTransform = isPrimaryColor(color, fromColor, threshold);
                }
                
                if (shouldTransform) {
                    const newColor = transformColor(color, fromColor, toColor);
                    transformedSVG = transformedSVG.replace(new RegExp(color, 'gi'), newColor);
                    transformedColors.add(newColor);
                    transformedCount++;
                } else {
                    transformedColors.add(color);
                }
            });
            
            // Display transformed SVG
            displaySVG('transformedPreview', transformedSVG);
            
            // Enable buttons
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('copyBtn').disabled = false;
            
            // Update stats
            const forcedCount = Object.values(colorStates).filter(state => state === 'forced').length;
            const excludedCount = Object.values(colorStates).filter(state => state === 'excluded').length;
            const autoDetectedCount = allColors.filter(color => {
                const state = colorStates[color] || 'auto';
                return state === 'auto' && isPrimaryColor(color, fromColor, threshold);
            }).length;
            
            const statsHtml = `
                <div class="stat">
                    <div class="stat-value">${allColors.length}</div>
                    <div class="stat-label">Unique Colors</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${transformedCount}</div>
                    <div class="stat-label">Transformed</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${autoDetectedCount}</div>
                    <div class="stat-label">Auto-detected</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${forcedCount}</div>
                    <div class="stat-label">Forced</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${excludedCount}</div>
                    <div class="stat-label">Excluded</div>
                </div>
            `;
            document.getElementById('stats').innerHTML = statsHtml;
            
            // Refresh color grid to show current states
            if (allColors.length > 0) {
                displayColorGrid(allColors.reduce((acc, c) => {
                    const matches = originalSVG.match(new RegExp(c.replace('#', '\\#'), 'gi')) || [];
                    acc[c] = matches.length;
                    return acc;
                }, {}));
            }
        }

        function downloadSVG() {
            if (!transformedSVG) return;
            
            const blob = new Blob([transformedSVG], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFilename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copySVGCode() {
            if (!transformedSVG) return;
            
            navigator.clipboard.writeText(transformedSVG).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
    </script>
</body>
</html>